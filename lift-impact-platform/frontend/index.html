<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharma Causality Lab</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; margin: 0; background: #f5f7fb; color: #1f2a44; }
    .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .title { font-size: 28px; font-weight: 700; margin-bottom: 6px; }
    .subtitle { color: #54607a; margin-bottom: 20px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 3px 16px rgba(16,24,40,.08); margin-bottom: 16px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .tab { border: 1px solid #d4d9e7; background: #fff; border-radius: 10px; padding: 8px 12px; cursor: pointer; }
    .tab.active { background: #1f5eff; color: #fff; border-color: #1f5eff; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #d4d9e7; }
    button.primary { background: #1f5eff; color: #fff; border: none; cursor: pointer; }
    pre { background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: 13px; }
    .pill-pass { color: #086a3c; } .pill-warn { color: #a15c00; }
    .muted { color: #667085; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState } = React;

function DataTable({ rows }) {
  if (!rows || !rows.length) return <p className="muted">No rows.</p>;
  const cols = Object.keys(rows[0]);
  return <table><thead><tr>{cols.map(c => <th key={c}>{c}</th>)}</tr></thead><tbody>{rows.map((r,i)=><tr key={i}>{cols.map(c=><td key={c}>{String(r[c])}</td>)}</tr>)}</tbody></table>;
}

function App() {
  const [active, setActive] = useState('Upload');
  const [file, setFile] = useState(null);
  const [fileId, setFileId] = useState('');
  const [schema, setSchema] = useState(null);
  const [checklist, setChecklist] = useState([]);
  const [metricGroup, setMetricGroup] = useState('Suggestions');
  const [eda, setEda] = useState(null);
  const [variable, setVariable] = useState('');
  const [includeZ, setIncludeZ] = useState(false);
  const [summary, setSummary] = useState(null);
  const [multiplier, setMultiplier] = useState(1.0);
  const [channel, setChannel] = useState('');
  const [err, setErr] = useState('');

  const upload = async () => {
    setErr('');
    if (!file) return;
    const form = new FormData(); form.append('file', file);
    const res = await fetch('/upload', { method: 'POST', body: form });
    const payload = await res.json();
    if (!res.ok) return setErr(payload.detail || 'Upload failed');
    setFileId(payload.file_id); setSchema(payload.schema); setActive('Schema & Variables');
  };

  const loadChecklist = async () => {
    if (!fileId) return;
    const res = await fetch(`/checklist/${fileId}`); const payload = await res.json();
    if (res.ok) setChecklist(payload.items || []);
  };

  const loadEda = async () => {
    if (!fileId) return;
    const params = new URLSearchParams({ metric_group: metricGroup, include_zscore: String(includeZ) });
    if (variable) params.set('variable', variable);
    const res = await fetch(`/eda/${fileId}?${params.toString()}`); const payload = await res.json();
    if (res.ok) {
      setEda(payload);
      if (!variable) {
        const options = (payload.metric_groups && payload.metric_groups[metricGroup]) || [];
        if (options.length) setVariable(options[0]);
      }
    }
  };

  const runModel = async () => {
    if (!fileId) return;
    const res = await fetch(`/run/${fileId}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ scenario_multiplier: Number(multiplier), isolate_channel: channel || null })
    });
    const payload = await res.json();
    if (res.ok) setSummary(payload.summary);
  };

  const tabs = ['Upload','Schema & Variables','EDA','Modeling'];

  return <div className="container">
    <div className="title">Pharma Causality Lab</div>
    <div className="subtitle">Corporate causal analysis workspace for Suggestions → Actions → Outcomes.</div>
    <div className="tabs">{tabs.map(t => <button key={t} className={`tab ${active===t?'active':''}`} onClick={()=>setActive(t)}>{t}</button>)}</div>
    {err && <div className="card" style={{border:'1px solid #f59e0b'}}>{err}</div>}

    {active==='Upload' && <div className="card">
      <h3>Upload dataset</h3>
      <input type="file" accept=".xlsx,.xls" onChange={e=>setFile(e.target.files[0])} />
      <button className="primary" style={{marginLeft:8}} onClick={upload}>Upload & Detect Schema</button>
      {fileId && <p>Loaded file id: <b>{fileId}</b></p>}
    </div>}

    {active==='Schema & Variables' && <div className="card">
      <h3>Variable Checklist</h3>
      <button onClick={loadChecklist}>Refresh checklist</button>
      {checklist.map((c,i)=><p key={i}><span className={c.status==='pass'?'pill-pass':'pill-warn'}>{c.status==='pass'?'✅':'⚠️'} {c.label}</span> — {c.detail}</p>)}
      <h3>Detected schema</h3>
      <pre>{JSON.stringify(schema, null, 2)}</pre>
    </div>}

    {active==='EDA' && <div className="card">
      <h3>EDA (Month-level)</h3>
      <div className="grid">
        <select value={metricGroup} onChange={e=>{setMetricGroup(e.target.value); setVariable('');}}>
          <option>Suggestions</option><option>Actions</option><option>Outcomes</option><option>Other Variables</option>
        </select>
        <input placeholder="Variable name (optional)" value={variable} onChange={e=>setVariable(e.target.value)} />
      </div>
      <label><input type="checkbox" checked={includeZ} onChange={e=>setIncludeZ(e.target.checked)} /> Include z-score outlier count</label>
      <div><button className="primary" onClick={loadEda}>Load EDA</button></div>
      {eda && <>
        <p>Action uptake: <b>{(eda.action_uptake_rate*100).toFixed(2)}%</b> · Suggestion→Action conversion: <b>{(eda.suggestion_to_action_conversion*100).toFixed(2)}%</b></p>
        <p>Variable profile:</p><pre>{JSON.stringify(eda.variable_profile, null, 2)}</pre>
        <p>Outliers:</p><pre>{JSON.stringify(eda.outliers, null, 2)}</pre>
        <h4>Monthly variable trend</h4><DataTable rows={eda.monthly_variable_trend || []} />
      </>}
    </div>}

    {active==='Modeling' && <div className="card">
      <h3>Path A + Path B</h3>
      <div className="grid">
        <input type="number" step="0.1" value={multiplier} onChange={e=>setMultiplier(e.target.value)} placeholder="Scenario multiplier"/>
        <input value={channel} onChange={e=>setChannel(e.target.value)} placeholder="Isolate channel (optional)" />
      </div>
      <button className="primary" onClick={runModel}>Run Modeling</button>
      {summary && <>
        <h4>Path A diagnostics</h4><pre>{JSON.stringify(summary.path_a?.diagnostics || {}, null, 2)}</pre>
        <DataTable rows={summary.path_a?.monthly_rollup || []} />
        <h4>Path B diagnostics</h4><pre>{JSON.stringify(summary.path_b?.diagnostics || {}, null, 2)}</pre>
        <DataTable rows={summary.path_b?.monthly_rollup || []} />
      </>}
    </div>}
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
